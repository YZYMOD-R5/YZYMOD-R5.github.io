<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Button Controlled Animation Test</title>
  <style>
    #spriteCanvas {
      border: 3px solid #6c757d;
      background-color: #f8f9fa;
      display: block;
      margin: 20px auto;
    }
    body { text-align: center; font-family: Arial, sans-serif; }
    .controls {
      margin-bottom: 15px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="controls">
    <button data-set="manuscript">Manuscript</button>
    <button data-set="wip">WIP</button>
    <button data-set="final">Final</button>
  </div>

  <canvas id="spriteCanvas"></canvas>

  <script>
    const canvas = document.getElementById('spriteCanvas');
    const ctx = canvas.getContext('2d');

    const ORIGINAL_WIDTH = 1340;
    const ORIGINAL_HEIGHT = 1936;

    const DISPLAY_WIDTH = ORIGINAL_WIDTH * 0.375;
    const DISPLAY_HEIGHT = ORIGINAL_HEIGHT * 0.375;

    canvas.width = DISPLAY_WIDTH;
    canvas.height = DISPLAY_HEIGHT;

    const FRAME_FPS = 12;
    let FRAME_FILES = [];
    let FRAME_COUNT = 0;
    let frameImages = [];

    let animationSets = {};

    let currentFrameIndex = 0;
    let lastTime = 0;
    const msPerFrame = 1000 / FRAME_FPS;

    // Load animation data
    fetch('frames.json')
      .then(response => response.json())
      .then(data => {
        animationSets = data;
        loadAnimation('manuscript');
        requestAnimationFrame(gameLoop);
      })
      .catch(err => {
        console.error('Failed to load frames.json', err);
      });

    function loadAnimation(setName) {
      const data = animationSets[setName];
      if (!data || !data.frames) return;

      FRAME_FILES = data.frames;
      FRAME_COUNT = FRAME_FILES.length;
      frameImages = [];
      currentFrameIndex = 0;
      lastTime = 0; // reset timing for restart

      let loadedCount = 0;

      FRAME_FILES.forEach((fileName, index) => {
        const img = new Image();

        img.onload = () => {
          loadedCount++;
          if (loadedCount === FRAME_COUNT) {
            console.log(setName + " fully loaded");
          }
        };

        img.onerror = () => {
          console.warn("Failed to load:", fileName);
        };

        // Cache buster ensures re-click works even on same set
        img.src = fileName + "?v=" + Date.now();
        frameImages[index] = img;
      });
    }

    document.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        loadAnimation(btn.dataset.set);
      });
    });

    function gameLoop(time) {
      if (!lastTime) lastTime = time;
      const delta = time - lastTime;

      if (delta >= msPerFrame && FRAME_COUNT > 0) {
        currentFrameIndex = (currentFrameIndex + 1) % FRAME_COUNT;
        lastTime = time;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const img = frameImages[currentFrameIndex];

      if (img && img.complete) {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }

      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
